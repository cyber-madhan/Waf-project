services:
  waf:
    image: owasp/modsecurity-crs:nginx
    container_name: waf-proxy
    entrypoint: [ "/opt/waf-scripts/docker-entrypoint-wrapper.sh" ]
    command: [ "nginx", "-g", "daemon off;" ]
    restart: unless-stopped
    ports:
      - "80:80"
      - "8080:8080" # Metrics endpoint for Prometheus
    environment:
      - SERVER_NAME=localhost
      - BACKEND=https://juice-shop.herokuapp.com
      # ModSecurity Configuration
      - MODSEC_RULE_ENGINE=On
      - PARANOIA=2
      - ANOMALYIN=5
      - ANOMALYOUT=4
      - BLOCKING_PARANOIA=2
      # Request/Response Body Limits
      - MAX_FILE_SIZE=10485760
      - COMBINED_FILE_SIZES=10485760
      # Performance Tuning
      - TIMEOUT=60
      - PROXY_TIMEOUT=60
      - PROXY_SSL_VERIFY=off
      # Additional Security
      - VALIDATE_UTF8_ENCODING=On
      - ALLOWED_METHODS=GET HEAD POST OPTIONS PUT PATCH DELETE
      - ALLOWED_REQUEST_CONTENT_TYPE=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/json|
      - ALLOWED_HTTP_VERSIONS=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0
    volumes:

      - ./nginx/default.conf.template:/etc/nginx/templates/conf.d/default.conf.template:ro
      # Entrypoint wrapper script
      - ./waf/scripts:/opt/waf-scripts:ro
      # Custom CRS setup only (don't override base modsecurity.conf)
      - ./waf/config/crs-setup-custom.conf:/etc/modsecurity.d/owasp-crs/crs-setup-custom.conf:ro
      # Custom security rules
      - ./waf/rules:/etc/modsecurity.d/custom-rules:ro
    networks:
      - waf-net
      - monitoring-net

networks:
  waf-net:
    driver: bridge
  monitoring-net:
    external: true
    name: waf-lab_monitoring-net
