# ========================================
# OWASP CRS Custom Setup Configuration
# ========================================
# This file contains CRS-specific settings and customizations
# Override default CRS settings here

# ----------------------------------------
# Paranoia Level Configuration
# ----------------------------------------
# Paranoia Level 1: Basic security (default)
# Paranoia Level 2: Elevated security with some false positives
# Paranoia Level 3: High security with more false positives
# Paranoia Level 4: Maximum security with highest false positive rate

SecAction \
 "id:900000,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.paranoia_level=2"

# Execute Paranoia Level 2 and lower rules
SecAction \
 "id:900001,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.executing_paranoia_level=2"

# ----------------------------------------
# Anomaly Scoring Configuration
# ----------------------------------------

# Inbound Anomaly Score Threshold
# Score required to trigger blocking (lower = more strict)
# Recommended: 5 for PL1, 4 for PL2, 3 for PL3
SecAction \
 "id:900110,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.inbound_anomaly_score_threshold=5"

# Outbound Anomaly Score Threshold
SecAction \
 "id:900111,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.outbound_anomaly_score_threshold=4"

# ----------------------------------------
# Sampling Configuration
# ----------------------------------------

# Sampling percentage (100 = check all requests)
SecAction \
 "id:900400,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.sampling_percentage=100"

# ----------------------------------------
# Enforcement Mode
# ----------------------------------------

# Blocking mode (On) or Detection mode (Off)
SecAction \
 "id:900500,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.blocking_paranoia_level=2"

# ----------------------------------------
# Protocol Attack Protection
# ----------------------------------------

# HTTP Policy Settings
SecAction \
 "id:900200,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE',\
  setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json|',\
  setvar:'tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0',\
  setvar:'tx.restricted_extensions=.asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .rdb/ .resources/ .resx/ .sql/ .swp/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/',\
  setvar:'tx.restricted_headers=/content-encoding/ /proxy/ /lock-token/ /content-range/ /if/ /x-http-method-override/ /x-http-method/ /x-method-override/'"

# ----------------------------------------
# Application-Specific Configuration
# ----------------------------------------

# Maximum file upload size (in bytes) - 10MB
SecAction \
 "id:900220,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.max_file_size=10485760"

# Maximum combined size of arguments (in bytes) - 64KB
SecAction \
 "id:900230,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.max_num_args=255,\
  setvar:tx.arg_name_length=400,\
  setvar:tx.arg_length=64000,\
  setvar:tx.total_arg_length=64000"

# ----------------------------------------
# XML Protection
# ----------------------------------------

# Enable XML parsing and protection
SecAction \
 "id:900240,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.xml_processor_enabled=1"

# ----------------------------------------
# Geographic Access Control
# ----------------------------------------

# Uncomment and configure to block specific countries
# SecGeoLookupDB /path/to/GeoIP.dat
# SecRule REMOTE_ADDR "@geoLookup" "chain,id:900300,phase:1,block,msg:'Blocked country access'"
# SecRule GEO:COUNTRY_CODE "@streq CN" "t:none"

# ----------------------------------------
# Rate Limiting Configuration
# ----------------------------------------

# Enable DOS protection (requires mod_security 3.x)
SecAction \
 "id:900350,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.dos_burst_time_slice=60,\
  setvar:tx.dos_counter_threshold=100,\
  setvar:tx.dos_block_timeout=600"

# ----------------------------------------
# Known Malicious Clients
# ----------------------------------------

# Block known bad bots and scanners
SecAction \
 "id:900380,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.malicious_ua_patterns=/nikto/ /sqlmap/ /masscan/ /nmap/ /acunetix/ /burpsuite/'"

# ----------------------------------------
# IP Reputation and Blacklisting
# ----------------------------------------

# Real-time blacklist checks (optional)
# SecAction \
#  "id:900390,\
#   phase:1,\
#   nolog,\
#   pass,\
#   t:none,\
#   setvar:tx.use_ip_reputation=1"

# ----------------------------------------
# Session and CSRF Protection
# ----------------------------------------

# Enable session tracking
SecAction \
 "id:900410,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.session_timeout=3600"

# ----------------------------------------
# Data Leakage Prevention
# ----------------------------------------

# Enable outbound data leak detection
SecAction \
 "id:900450,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.outbound_anomaly_score_threshold=4,\
  setvar:'tx.sensitive_data_patterns=/[0-9]{13,16}/ /[0-9]{3}-[0-9]{2}-[0-9]{4}/ /password/ /api[_-]?key/ /token/'"

# ----------------------------------------
# Custom Application Rules
# ----------------------------------------

# Set application-specific variables
SecAction \
 "id:900900,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.application_name=bwapp,\
  setvar:tx.application_version=1.0"

# ----------------------------------------
# Reporting and Audit
# ----------------------------------------

# Enhanced audit logging for blocked requests
SecAction \
 "id:900950,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.audit_log_level=3"
