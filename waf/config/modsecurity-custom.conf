# ========================================
# ModSecurity Custom Configuration
# ========================================
# This file contains custom ModSecurity settings optimized for
# production WAF deployment with OWASP CRS

# ----------------------------------------
# Core ModSecurity Engine Settings
# ----------------------------------------

# Enable ModSecurity engine (change to DetectionOnly for testing)
SecRuleEngine On

# Request body access and limits
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Response body access
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# File upload limits and handling
SecTmpDir /tmp/
SecDataDir /tmp/
SecUploadDir /tmp/
SecUploadKeepFiles Off
SecUploadFileMode 0600

# ----------------------------------------
# Debug and Logging Configuration
# ----------------------------------------

# Note: The base image configures logging via environment variables
# We disable logging configuration here to avoid conflicts
# Logs are handled by the base ModSecurity image

# ----------------------------------------
# Rule Matching and Performance
# ----------------------------------------

# PCRE tuning for performance
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

# Argument separator for parsing
SecArgumentSeparator &

# Cookie format (version 0 or 1)
SecCookieFormat 0

# ----------------------------------------
# Geographic and Colletion Settings
# ----------------------------------------

# Collection timeout for persistent storage
SecCollectionTimeout 600

# ----------------------------------------
# Response Status Codes
# ----------------------------------------

# Default action when rule matches
SecDefaultAction "phase:1,log,auditlog,pass"
SecDefaultAction "phase:2,log,auditlog,pass"

# ----------------------------------------
# Content Type Enforcement
# ----------------------------------------

# Allowed HTTP methods
SecAction \
  "id:900200,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE'"

# Allowed request content types
SecAction \
  "id:900220,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json|'"

# Allowed HTTP versions
SecAction \
  "id:900230,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0 HTTP/3'"

# File extensions considered static
SecAction \
  "id:900240,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.static_extensions=/.jpg/ /.jpeg/ /.png/ /.gif/ /.js/ /.css/ /.ico/ /.svg/ /.webp/'"

# ----------------------------------------
# Unicode and Encoding
# ----------------------------------------

SecUnicodeMapFile unicode.mapping 20127

# ----------------------------------------
# Performance Optimizations
# ----------------------------------------

# Remove Server header to reduce information disclosure
SecServerSignature "ModSecurity/3.x"

# Stream response body inspection
SecStreamOutBodyInspection Off

# ----------------------------------------
# Custom Variables for Application
# ----------------------------------------

# Set application-specific thresholds
SecAction \
  "id:900100,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.critical_anomaly_score=5,\
  setvar:tx.error_anomaly_score=4,\
  setvar:tx.warning_anomaly_score=3,\
  setvar:tx.notice_anomaly_score=2"

# Inbound and outbound anomaly score thresholds
SecAction \
  "id:900110,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.inbound_anomaly_score_threshold=5,\
  setvar:tx.outbound_anomaly_score_threshold=4"

# ----------------------------------------
# Custom Security Headers
# ----------------------------------------

# Add security headers to responses
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# Remove sensitive headers
Header always unset X-Powered-By
Header always unset Server

# ----------------------------------------
# Rule Inclusion
# ----------------------------------------

# Include OWASP CRS rules (loaded by base image)
# Include /etc/modsecurity.d/owasp-crs/*.conf

# Include custom rules
Include /etc/modsecurity.d/custom-rules/*.conf
