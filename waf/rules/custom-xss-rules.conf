# ========================================
# Custom Cross-Site Scripting (XSS) Protection Rules
# ========================================
# Enhanced XSS detection beyond OWASP CRS
# Rule ID Range: 9002000 - 9002999

# ----------------------------------------
# Script Tag Detection
# ----------------------------------------

# Detect basic script tags
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS|XML:/*|XML://@* \
  "@rx (?i:<script[^>]*>[\s\S]*?</script>)" \
  "id:9002001,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:htmlEntityDecode,t:lowercase,\
   msg:'XSS Attack: Script tag detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'application-multi',\
   tag:'language-multi',\
   tag:'attack-xss',\
   tag:'paranoia-level/1',\
   tag:'OWASP_CRS',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.xss_score=+1'"

# Detect self-closing script tags
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (?i:<script[^>]*/?>)" \
  "id:9002002,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:htmlEntityDecode,t:lowercase,\
   msg:'XSS Attack: Script tag (self-closing) detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-xss',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.xss_score=+1'"

# ----------------------------------------
# Event Handler Detection
# ----------------------------------------

# Detect inline event handlers (onerror, onload, etc.)
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (?i:on(error|load|click|mouse|focus|blur|change|submit|keypress|keydown|keyup)[\s]*=)" \
  "id:9002003,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:htmlEntityDecode,t:lowercase,\
   msg:'XSS Attack: Inline event handler detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-xss',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.xss_score=+1'"

# ----------------------------------------
# JavaScript Protocol Detection
# ----------------------------------------

# Detect javascript: protocol in attributes
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (?i:javascript:[\s\S]*)" \
  "id:9002004,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:htmlEntityDecode,t:lowercase,\
   msg:'XSS Attack: JavaScript protocol detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-xss',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.xss_score=+1'"

# Detect data: protocol (data URIs)
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (?i:data:text/html)" \
  "id:9002005,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:htmlEntityDecode,t:lowercase,\
   msg:'XSS Attack: Data protocol with HTML detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-xss',\
   tag:'paranoia-level/2',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}',\
   setvar:'tx.xss_score=+1'"

# ----------------------------------------
# Dangerous HTML Tags
# ----------------------------------------

# Detect iframe tags
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (?i:<iframe[^>]*>)" \
  "id:9002006,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:htmlEntityDecode,t:lowercase,\
   msg:'XSS Attack: iframe tag detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-xss',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.xss_score=+1'"

# Detect object/embed tags
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (?i:<(object|embed)[^>]*>)" \
  "id:9002007,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:htmlEntityDecode,t:lowercase,\
   msg:'XSS Attack: Object/Embed tag detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-xss',\
   tag:'paranoia-level/2',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}',\
   setvar:'tx.xss_score=+1'"

# ----------------------------------------
# Encoded XSS Attempts
# ----------------------------------------

# Detect HTML entity encoded scripts
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (?i:&#x?[0-9a-f]+;)" \
  "chain,\
   id:9002008,\
   phase:2,\
   block,\
   t:none,t:htmlEntityDecode,t:lowercase,\
   msg:'XSS Attack: HTML entity encoding detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-xss',\
   tag:'paranoia-level/2',\
   severity:'WARNING',\
   setvar:'tx.anomaly_score_pl2=+%{tx.warning_anomaly_score}',\
   setvar:'tx.xss_score=+1'"
SecRule MATCHED_VAR "@rx (?i:<script|javascript:)"

# Detect Unicode/UTF-7 encoded XSS
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (?i:\\u[0-9a-f]{4})" \
  "chain,\
   id:9002009,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'XSS Attack: Unicode encoding detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-xss',\
   tag:'paranoia-level/3',\
   severity:'WARNING',\
   setvar:'tx.anomaly_score_pl3=+%{tx.warning_anomaly_score}',\
   setvar:'tx.xss_score=+1'"
SecRule MATCHED_VAR "@rx (?i:\\u003c|\\u003e)"

# ----------------------------------------
# DOM-Based XSS Patterns
# ----------------------------------------

# Detect document.write/innerHTML manipulation
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (?i:(document\.(write|writeln|cookie)|innerHTML|outerHTML|insertAdjacentHTML)[\s]*[\(\[])" \
  "id:9002010,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'XSS Attack: DOM manipulation detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-xss',\
   tag:'paranoia-level/2',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}',\
   setvar:'tx.xss_score=+1'"

# Detect eval() and similar functions
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (?i:(eval|setTimeout|setInterval|Function)[\s]*\()" \
  "id:9002011,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'XSS Attack: Dangerous JavaScript function detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-xss',\
   tag:'paranoia-level/2',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}',\
   setvar:'tx.xss_score=+1'"

# ----------------------------------------
# SVG-Based XSS
# ----------------------------------------

# Detect SVG tags with script content
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (?i:<svg[^>]*>[\s\S]*<script)" \
  "id:9002012,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:htmlEntityDecode,t:lowercase,\
   msg:'XSS Attack: SVG-based XSS detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-xss',\
   tag:'paranoia-level/2',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}',\
   setvar:'tx.xss_score=+1'"

# ----------------------------------------
# AngularJS/Template Injection
# ----------------------------------------

# Detect AngularJS template expressions
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (?i:\{\{[\s\S]*\}\})" \
  "chain,\
   id:9002013,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,\
   msg:'XSS Attack: AngularJS template injection detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-xss',\
   tag:'paranoia-level/3',\
   severity:'WARNING',\
   setvar:'tx.anomaly_score_pl3=+%{tx.warning_anomaly_score}',\
   setvar:'tx.xss_score=+1'"
SecRule MATCHED_VAR "@rx (?i:constructor|__proto__|prototype)"

# ----------------------------------------
# XSS Score Threshold
# ----------------------------------------

# Block if XSS score exceeds threshold
SecRule TX:XSS_SCORE "@gt 0" \
  "id:9002099,\
   phase:2,\
   block,\
   msg:'XSS Attack Detected: Total Score: %{TX.XSS_SCORE}',\
   tag:'attack-xss',\
   severity:'CRITICAL',\
   setvar:'tx.inbound_anomaly_score=+%{tx.xss_score}'"
