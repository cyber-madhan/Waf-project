# ========================================
# Custom CSRF (Cross-Site Request Forgery) Protection Rules
# ========================================
# CSRF token validation and protection
# Rule ID Range: 9003000 - 9003999

# ----------------------------------------
# CSRF Token Configuration
# ----------------------------------------

# Initialize CSRF protection variables
SecAction \
  "id:9003000,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.csrf_protection_enabled=1,\
   setvar:tx.csrf_token_name=csrf_token,\
   setvar:tx.csrf_header_name=X-CSRF-Token"

# ----------------------------------------
# CSRF Token Validation for State-Changing Requests
# ----------------------------------------

# Check if request method requires CSRF protection (POST, PUT, DELETE, PATCH)
SecRule REQUEST_METHOD "@rx ^(POST|PUT|DELETE|PATCH)$" \
  "id:9003001,\
   phase:2,\
   pass,\
   nolog,\
   t:none,\
   setvar:tx.requires_csrf_check=1"

# Check for missing CSRF token in POST requests
SecRule TX:REQUIRES_CSRF_CHECK "@eq 1" \
  "chain,\
   id:9003002,\
   phase:2,\
   block,\
   t:none,\
   msg:'CSRF Attack: Missing CSRF token in state-changing request',\
   logdata:'Request Method: %{REQUEST_METHOD}, URI: %{REQUEST_URI}',\
   tag:'attack-csrf',\
   tag:'paranoia-level/2',\
   severity:'WARNING',\
   setvar:'tx.anomaly_score_pl2=+%{tx.warning_anomaly_score}',\
   setvar:'tx.csrf_score=+1'"
SecRule &ARGS:csrf_token "@eq 0" \
  "chain,\
   t:none"
SecRule &REQUEST_HEADERS:X-CSRF-Token "@eq 0" \
  "chain,\
   t:none"
SecRule REQUEST_URI "!@rx (?i:/api/|/webhook/|/public/)" \
  "t:none"

# ----------------------------------------
# Referer Header Validation
# ----------------------------------------

# Check if Referer header is present for state-changing requests
SecRule TX:REQUIRES_CSRF_CHECK "@eq 1" \
  "chain,\
   id:9003003,\
   phase:2,\
   block,\
   t:none,\
   msg:'CSRF Attack: Missing Referer header in state-changing request',\
   logdata:'Request Method: %{REQUEST_METHOD}, URI: %{REQUEST_URI}',\
   tag:'attack-csrf',\
   tag:'paranoia-level/2',\
   severity:'WARNING',\
   setvar:'tx.anomaly_score_pl2=+%{tx.warning_anomaly_score}',\
   setvar:'tx.csrf_score=+1'"
SecRule &REQUEST_HEADERS:Referer "@eq 0" \
  "chain,\
   t:none"
SecRule REQUEST_URI "!@rx (?i:/api/|/webhook/|/public/)" \
  "t:none"

# Validate Referer header matches expected domain
SecRule TX:REQUIRES_CSRF_CHECK "@eq 1" \
  "chain,\
   id:9003004,\
   phase:2,\
   block,\
   t:none,\
   msg:'CSRF Attack: Invalid Referer header detected',\
   logdata:'Referer: %{REQUEST_HEADERS.Referer}, Expected Host: %{REQUEST_HEADERS.Host}',\
   tag:'attack-csrf',\
   tag:'paranoia-level/2',\
   severity:'WARNING',\
   setvar:'tx.anomaly_score_pl2=+%{tx.warning_anomaly_score}',\
   setvar:'tx.csrf_score=+1'"
SecRule REQUEST_HEADERS:Referer "!@rx ^https?://(%{REQUEST_HEADERS.Host}|localhost)" \
  "chain,\
   t:none,t:lowercase"
SecRule REQUEST_URI "!@rx (?i:/api/|/webhook/|/public/)" \
  "t:none"

# ----------------------------------------
# Origin Header Validation
# ----------------------------------------

# Validate Origin header if present
SecRule &REQUEST_HEADERS:Origin "@gt 0" \
  "chain,\
   id:9003005,\
   phase:2,\
   block,\
   t:none,\
   msg:'CSRF Attack: Invalid Origin header detected',\
   logdata:'Origin: %{REQUEST_HEADERS.Origin}, Expected Host: %{REQUEST_HEADERS.Host}',\
   tag:'attack-csrf',\
   tag:'paranoia-level/2',\
   severity:'WARNING',\
   setvar:'tx.anomaly_score_pl2=+%{tx.warning_anomaly_score}',\
   setvar:'tx.csrf_score=+1'"
SecRule REQUEST_HEADERS:Origin "!@rx ^https?://(%{REQUEST_HEADERS.Host}|localhost)" \
  "chain,\
   t:none,t:lowercase"
SecRule TX:REQUIRES_CSRF_CHECK "@eq 1" \
  "chain,\
   t:none"
SecRule REQUEST_URI "!@rx (?i:/api/|/webhook/|/public/)" \
  "t:none"

# ----------------------------------------
# SameSite Cookie Enforcement
# ----------------------------------------

# Check for session cookies without SameSite attribute
SecRule RESPONSE_HEADERS:Set-Cookie "@rx (?i:session|auth|token)" \
  "chain,\
   id:9003006,\
   phase:3,\
   pass,\
   t:none,\
   msg:'CSRF Protection: Session cookie without SameSite attribute',\
   logdata:'Cookie: %{MATCHED_VAR}',\
   tag:'csrf-protection',\
   tag:'paranoia-level/3',\
   severity:'NOTICE',\
   setvar:'tx.anomaly_score_pl3=+%{tx.notice_anomaly_score}'"
SecRule MATCHED_VAR "!@rx (?i:SameSite=(Strict|Lax))" \
  "t:none"

# ----------------------------------------
# Content-Type Validation
# ----------------------------------------

# Ensure Content-Type is appropriate for POST requests
SecRule REQUEST_METHOD "@streq POST" \
  "chain,\
   id:9003007,\
   phase:2,\
   block,\
   t:none,\
   msg:'CSRF Attack: Invalid Content-Type for POST request',\
   logdata:'Content-Type: %{REQUEST_HEADERS.Content-Type}',\
   tag:'attack-csrf',\
   tag:'paranoia-level/3',\
   severity:'WARNING',\
   setvar:'tx.anomaly_score_pl3=+%{tx.warning_anomaly_score}',\
   setvar:'tx.csrf_score=+1'"
SecRule REQUEST_HEADERS:Content-Type "!@rx (?i:application/x-www-form-urlencoded|multipart/form-data|application/json|text/plain)" \
  "chain,\
   t:none"
SecRule REQUEST_URI "!@rx (?i:/api/|/webhook/|/upload/)" \
  "t:none"

# ----------------------------------------
# Double Submit Cookie Pattern
# ----------------------------------------

# Validate CSRF token matches cookie value (double submit pattern)
SecRule TX:REQUIRES_CSRF_CHECK "@eq 1" \
  "chain,\
   id:9003008,\
   phase:2,\
   block,\
   t:none,\
   msg:'CSRF Attack: Token mismatch in double-submit pattern',\
   logdata:'Cookie Token: %{REQUEST_COOKIES.csrf_token}, Form Token: %{ARGS.csrf_token}',\
   tag:'attack-csrf',\
   tag:'paranoia-level/2',\
   severity:'WARNING',\
   setvar:'tx.anomaly_score_pl2=+%{tx.warning_anomaly_score}',\
   setvar:'tx.csrf_score=+1'"
SecRule &REQUEST_COOKIES:csrf_token "@gt 0" \
  "chain,\
   t:none"
SecRule &ARGS:csrf_token "@gt 0" \
  "chain,\
   t:none"
SecRule REQUEST_COOKIES:csrf_token "!@streq %{ARGS.csrf_token}" \
  "chain,\
   t:none"
SecRule REQUEST_URI "!@rx (?i:/api/|/webhook/|/public/)" \
  "t:none"

# ----------------------------------------
# Custom Header Verification
# ----------------------------------------

# Check for custom header presence (AJAX requests typically include these)
SecRule TX:REQUIRES_CSRF_CHECK "@eq 1" \
  "chain,\
   id:9003009,\
   phase:2,\
   pass,\
   t:none,\
   msg:'CSRF Protection: No custom headers detected',\
   logdata:'Request lacks X-Requested-With header',\
   tag:'csrf-protection',\
   tag:'paranoia-level/3',\
   severity:'NOTICE'"
SecRule &REQUEST_HEADERS:X-Requested-With "@eq 0" \
  "chain,\
   t:none"
SecRule &REQUEST_HEADERS:X-CSRF-Token "@eq 0" \
  "chain,\
   t:none"
SecRule REQUEST_URI "!@rx (?i:/api/|/webhook/|/public/)" \
  "t:none"

# ----------------------------------------
# Login CSRF Protection
# ----------------------------------------

# Protect login forms from CSRF
SecRule REQUEST_URI "@rx (?i:/login|/signin|/authenticate)" \
  "chain,\
   id:9003010,\
   phase:2,\
   block,\
   t:none,t:lowercase,\
   msg:'CSRF Attack: Missing CSRF token in login request',\
   logdata:'URI: %{REQUEST_URI}',\
   tag:'attack-csrf',\
   tag:'paranoia-level/2',\
   severity:'WARNING',\
   setvar:'tx.anomaly_score_pl2=+%{tx.warning_anomaly_score}',\
   setvar:'tx.csrf_score=+1'"
SecRule REQUEST_METHOD "@streq POST" \
  "chain,\
   t:none"
SecRule &ARGS:csrf_token "@eq 0" \
  "chain,\
   t:none"
SecRule &REQUEST_HEADERS:X-CSRF-Token "@eq 0" \
  "t:none"

# ----------------------------------------
# Suspicious Request Pattern Detection
# ----------------------------------------

# Detect automated/scripted requests without proper headers
SecRule TX:REQUIRES_CSRF_CHECK "@eq 1" \
  "chain,\
   id:9003011,\
   phase:2,\
   pass,\
   t:none,\
   msg:'CSRF Protection: Suspicious request pattern detected',\
   logdata:'User-Agent: %{REQUEST_HEADERS.User-Agent}',\
   tag:'csrf-protection',\
   tag:'paranoia-level/3',\
   severity:'NOTICE'"
SecRule REQUEST_HEADERS:User-Agent "@rx (?i:curl|wget|python|java|go-http|libwww)" \
  "chain,\
   t:none"
SecRule REQUEST_URI "!@rx (?i:/api/|/webhook/|/health|/metrics)" \
  "t:none"

# ----------------------------------------
# CSRF Score Threshold
# ----------------------------------------

# Log CSRF score for monitoring
SecRule TX:CSRF_SCORE "@gt 0" \
  "id:9003099,\
   phase:2,\
   pass,\
   msg:'CSRF Protection Alert: Total Score: %{TX.CSRF_SCORE}',\
   tag:'attack-csrf',\
   severity:'WARNING',\
   setvar:'tx.inbound_anomaly_score=+%{tx.csrf_score}'"
