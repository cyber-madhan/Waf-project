# ========================================
# Custom SQL Injection Protection Rules
# ========================================
# Enhanced SQLi detection beyond OWASP CRS
# Rule ID Range: 9001000 - 9001999

# ----------------------------------------
# Advanced SQL Injection Patterns
# ----------------------------------------

# Detect UNION-based SQL injection attempts
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS|XML:/*|XML://@* \
  "@rx (?i:union[\s\w]*select)" \
  "id:9001001,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'SQL Injection Attack: UNION-based SQLi detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'application-multi',\
   tag:'language-multi',\
   tag:'platform-multi',\
   tag:'attack-sqli',\
   tag:'paranoia-level/1',\
   tag:'OWASP_CRS',\
   ver:'CUSTOM/1.0',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.sql_injection_score=+1'"

# Detect SQL comments (/* */ , --, #)
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:(/\*|\*/|--|#))" \
  "id:9001002,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,\
   msg:'SQL Injection Attack: SQL comment sequence detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-sqli',\
   tag:'paranoia-level/2',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}',\
   setvar:'tx.sql_injection_score=+1'"

# Detect Boolean-based blind SQL injection
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:(and|or)\s+[\'\"]?\d+[\'\"]?\s*=\s*[\'\"]?\d+)" \
  "id:9001003,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'SQL Injection Attack: Boolean-based blind SQLi detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-sqli',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.sql_injection_score=+1'"

# Detect time-based blind SQL injection
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:(sleep|benchmark|waitfor\s+delay)[\s\(])" \
  "id:9001004,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'SQL Injection Attack: Time-based blind SQLi detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-sqli',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.sql_injection_score=+1'"

# Detect stacked queries
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:;\s*(select|insert|update|delete|drop|create|alter|exec|execute))" \
  "id:9001005,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'SQL Injection Attack: Stacked queries detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-sqli',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.sql_injection_score=+1'"

# Detect SQL function calls
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:(concat|substring|char|ascii|hex|unhex|load_file|into\s+outfile)[\s\(])" \
  "id:9001006,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'SQL Injection Attack: Dangerous SQL function detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-sqli',\
   tag:'paranoia-level/2',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}',\
   setvar:'tx.sql_injection_score=+1'"

# Detect SQL authentication bypass attempts
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:([\'\"]?\s*or\s+[\'\"]?1[\'\"]?\s*=\s*[\'\"]?1|admin[\'\"]?\s*(--|#)|[\'\"]?\s*or\s+[\'\"]?[a-z]+[\'\"]?\s*=\s*[\'\"]?[a-z]+))" \
  "id:9001007,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'SQL Injection Attack: Authentication bypass attempt detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-sqli',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.sql_injection_score=+1'"

# Detect SQL database enumeration
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:(information_schema|sysobjects|syscolumns|mysql\.user|pg_catalog))" \
  "id:9001008,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'SQL Injection Attack: Database enumeration attempt detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-sqli',\
   tag:'paranoia-level/2',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}',\
   setvar:'tx.sql_injection_score=+1'"

# Detect SQL error-based injection
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:(having|group\s+by|order\s+by)\s+\d+)" \
  "id:9001009,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'SQL Injection Attack: Error-based SQLi detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-sqli',\
   tag:'paranoia-level/2',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}',\
   setvar:'tx.sql_injection_score=+1'"

# Detect hex encoding bypass attempts
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:0x[0-9a-f]{2,})" \
  "id:9001010,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,\
   msg:'SQL Injection Attack: Hex encoding detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-sqli',\
   tag:'paranoia-level/3',\
   severity:'WARNING',\
   setvar:'tx.anomaly_score_pl3=+%{tx.warning_anomaly_score}',\
   setvar:'tx.sql_injection_score=+1'"

# ----------------------------------------
# SQL Injection Score Threshold
# ----------------------------------------

# Block if SQL injection score exceeds threshold
SecRule TX:SQL_INJECTION_SCORE "@gt 0" \
  "id:9001099,\
   phase:2,\
   block,\
   msg:'SQL Injection Attack Detected: Total Score: %{TX.SQL_INJECTION_SCORE}',\
   tag:'attack-sqli',\
   severity:'CRITICAL',\
   setvar:'tx.inbound_anomaly_score=+%{tx.sql_injection_score}'"
