# ========================================
# Rule Exclusions and Whitelisting
# ========================================
# Use this file to exclude specific rules for legitimate application behavior
# Rule ID Range: 9004000 - 9004999

# ----------------------------------------
# Global Exclusions
# ----------------------------------------

# Exclude specific parameters from all rule checking (use sparingly)
# Example: Exclude rich text editor content from XSS checks
# SecRuleUpdateTargetById 9002001-9002099 "!ARGS:editor_content"

# ----------------------------------------
# Application-Specific Exclusions
# ----------------------------------------

# Juice Shop specific exclusions (for testing purposes)
# Allow certain test parameters to pass through

# Exclude SQL injection rules for specific test endpoints
SecRule REQUEST_URI "@rx ^/sqli/" \
  "id:9004001,\
   phase:1,\
   pass,\
   nolog,\
   t:none,\
   ctl:ruleRemoveById=9001001-9001099"

# Exclude XSS rules for specific test endpoints
SecRule REQUEST_URI "@rx ^/xss/" \
  "id:9004002,\
   phase:1,\
   pass,\
   nolog,\
   t:none,\
   ctl:ruleRemoveById=9002001-9002099"

# ----------------------------------------
# API Endpoint Exclusions
# ----------------------------------------

# Relax rules for authenticated API endpoints
SecRule REQUEST_URI "@beginsWith /api/" \
  "id:9004010,\
   phase:1,\
   pass,\
   nolog,\
   t:none,\
   ctl:ruleRemoveById=9003001-9003099"

# Webhook endpoints don't need CSRF protection
SecRule REQUEST_URI "@rx ^/(webhook|callback|ipn)/" \
  "id:9004011,\
   phase:1,\
   pass,\
   nolog,\
   t:none,\
   ctl:ruleRemoveById=9003001-9003099"

# ----------------------------------------
# Static Content Exclusions
# ----------------------------------------

# Skip WAF processing for static assets
SecRule REQUEST_URI "@rx \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg|webp)$" \
  "id:9004020,\
   phase:1,\
   pass,\
   nolog,\
   t:none,t:lowercase,\
   ctl:ruleEngine=Off"

# ----------------------------------------
# Admin Interface Exclusions
# ----------------------------------------

# Admin panels may need relaxed rules
# Uncomment and customize as needed
# SecRule REQUEST_URI "@beginsWith /admin/" \
#   "chain,\
#    id:9004030,\
#    phase:1,\
#    pass,\
#    nolog,\
#    t:none"
# SecRule REMOTE_ADDR "@ipMatch 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16" \
#   "t:none,\
#    ctl:ruleRemoveById=9001001-9003099"

# ----------------------------------------
# File Upload Exclusions
# ----------------------------------------

# Allow larger payloads for file uploads
SecRule REQUEST_URI "@rx ^/(upload|import|export)/" \
  "id:9004040,\
   phase:1,\
   pass,\
   nolog,\
   t:none,\
   ctl:requestBodyLimit=52428800"

# ----------------------------------------
# JSON API Exclusions
# ----------------------------------------

# JSON APIs may contain patterns that trigger false positives
SecRule REQUEST_HEADERS:Content-Type "@rx application/json" \
  "id:9004050,\
   phase:1,\
   pass,\
   nolog,\
   t:none,\
   ctl:ruleRemoveTargetById=9001002;ARGS"

# ----------------------------------------
# Search Functionality Exclusions
# ----------------------------------------

# Search queries may legitimately contain special characters
SecRule REQUEST_URI "@rx ^/(search|query|find)/" \
  "id:9004060,\
   phase:1,\
   pass,\
   nolog,\
   t:none,\
   ctl:ruleRemoveTargetById=9001001-9001010;ARGS:q,\
   ctl:ruleRemoveTargetById=9001001-9001010;ARGS:query,\
   ctl:ruleRemoveTargetById=9001001-9001010;ARGS:search"

# ----------------------------------------
# Development/Testing Exclusions
# ----------------------------------------

# Disable WAF for health check endpoints
SecRule REQUEST_URI "@rx ^/(health|status|ping|metrics)$" \
  "id:9004070,\
   phase:1,\
   pass,\
   nolog,\
   t:none,t:lowercase,\
   ctl:ruleEngine=Off"

# Allow internal monitoring tools
SecRule REMOTE_ADDR "@ipMatch 127.0.0.1" \
  "chain,\
   id:9004071,\
   phase:1,\
   pass,\
   nolog,\
   t:none"
SecRule REQUEST_HEADERS:User-Agent "@rx (?i:monitoring|nagios|zabbix|prometheus)" \
  "t:none,\
   ctl:ruleEngine=Off"

# ----------------------------------------
# Third-Party Integration Exclusions
# ----------------------------------------

# Payment gateway callbacks
# SecRule REQUEST_URI "@rx ^/(payment|checkout)/(callback|notify|webhook)/" \
#   "id:9004080,\
#    phase:1,\
#    pass,\
#    nolog,\
#    t:none,\
#    ctl:ruleRemoveById=9003001-9003099"

# ----------------------------------------
# Known False Positive Patterns
# ----------------------------------------

# Exclude legitimate patterns that trigger false positives
# Add specific exclusions as you discover them during testing

# Example: Legitimate use of SQL keywords in content
# SecRuleUpdateTargetById 9001008 "!ARGS:article_content"
# SecRuleUpdateTargetById 9001008 "!ARGS:post_body"

# ----------------------------------------
# IP Whitelist
# ----------------------------------------

# Completely disable WAF for trusted IP addresses (use with caution)
# SecRule REMOTE_ADDR "@ipMatch 10.0.1.100" \
#   "id:9004090,\
#    phase:1,\
#    pass,\
#    nolog,\
#    t:none,\
#    ctl:ruleEngine=Off"

# ----------------------------------------
# User Agent Whitelist
# ----------------------------------------

# Allow specific monitoring/health check tools
SecRule REQUEST_HEADERS:User-Agent "@rx (?i:^(GoogleHC|ELB-HealthChecker|kube-probe))$" \
  "id:9004100,\
   phase:1,\
   pass,\
   nolog,\
   t:none,\
   ctl:ruleEngine=Off"

# ----------------------------------------
# Response Body Exclusions
# ----------------------------------------

# Skip response body inspection for large files
SecRule RESPONSE_CONTENT_TYPE "@rx ^(application/octet-stream|application/zip|application/pdf|video/|audio/)" \
  "id:9004110,\
   phase:3,\
   pass,\
   nolog,\
   t:none,\
   ctl:responseBodyAccess=Off"

# ----------------------------------------
# Custom Exclusion Template
# ----------------------------------------

# Template for adding new exclusions:
# SecRule <CONDITION> \
#   "id:9004XXX,\
#    phase:1,\
#    pass,\
#    nolog,\
#    t:none,\
#    ctl:ruleRemoveById=XXXX-YYYY"
