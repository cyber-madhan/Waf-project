# ========================================
# Additional Security Protection Rules
# ========================================
# Covers: LFI, RFI, RCE, Path Traversal, XXE, and more
# Rule ID Range: 9005000 - 9005999

# ----------------------------------------
# Local File Inclusion (LFI) Protection
# ----------------------------------------

# Detect directory traversal attempts
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (?i:\.\.[\\/]|\.\.%2[fF]|%2e%2e[\\/]|%2e%2e%2[fF])" \
  "id:9005001,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,\
   msg:'Path Traversal Attack: Directory traversal pattern detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-lfi',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.lfi_score=+1'"

# Detect absolute path access attempts
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:(/etc/passwd|/etc/shadow|/proc/self|c:\\\\windows\\\\|c:\\\\boot\\.ini))" \
  "id:9005002,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'LFI Attack: System file access attempt detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-lfi',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.lfi_score=+1'"

# ----------------------------------------
# Remote File Inclusion (RFI) Protection
# ----------------------------------------

# Detect remote file inclusion attempts
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:https?://[^\s]+)" \
  "chain,\
   id:9005010,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'RFI Attack: Remote file inclusion attempt detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-rfi',\
   tag:'paranoia-level/2',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}',\
   setvar:'tx.rfi_score=+1'"
SecRule MATCHED_VAR "@rx (?i:\.(php|asp|aspx|jsp|cgi|pl))"

# Detect PHP wrappers in RFI
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:(php://|file://|expect://|zip://|data://))" \
  "id:9005011,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'RFI Attack: PHP wrapper detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-rfi',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.rfi_score=+1'"

# ----------------------------------------
# Remote Code Execution (RCE) Protection
# ----------------------------------------

# Detect shell command injection
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:[\|;&`$\(\)><]|\\x00)" \
  "chain,\
   id:9005020,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,\
   msg:'RCE Attack: Shell metacharacter detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-rce',\
   tag:'paranoia-level/2',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}',\
   setvar:'tx.rce_score=+1'"
SecRule MATCHED_VAR "@rx (?i:(whoami|cat|ls|wget|curl|nc|netcat|bash|sh|cmd|powershell))"

# Detect command execution functions
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:(exec|system|passthru|shell_exec|popen|proc_open|pcntl_exec)[\s]*\()" \
  "id:9005021,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'RCE Attack: Command execution function detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-rce',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.rce_score=+1'"

# ----------------------------------------
# XML External Entity (XXE) Protection
# ----------------------------------------

# Detect XXE attacks in XML payloads
SecRule REQUEST_HEADERS:Content-Type "@rx application/xml" \
  "chain,\
   id:9005030,\
   phase:2,\
   block,\
   t:none,t:lowercase,\
   msg:'XXE Attack: External entity declaration detected',\
   logdata:'Matched Data: %{MATCHED_VAR}',\
   tag:'attack-xxe',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.xxe_score=+1'"
SecRule REQUEST_BODY "@rx (?i:<!ENTITY[\s\S]+SYSTEM)" \
  "t:none"

# Detect DOCTYPE declarations with SYSTEM
SecRule REQUEST_BODY "@rx (?i:<!DOCTYPE[\s\S]+SYSTEM)" \
  "id:9005031,\
   phase:2,\
   block,\
   t:none,\
   msg:'XXE Attack: DOCTYPE with SYSTEM keyword detected',\
   logdata:'Matched Data: %{MATCHED_VAR}',\
   tag:'attack-xxe',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.xxe_score=+1'"

# ----------------------------------------
# Server-Side Request Forgery (SSRF) Protection
# ----------------------------------------

# Detect internal IP address access attempts
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:(http://|https://)?(10\.\d{1,3}\.\d{1,3}\.\d{1,3}|172\.(1[6-9]|2[0-9]|3[01])\.\d{1,3}\.\d{1,3}|192\.168\.\d{1,3}\.\d{1,3}|127\.\d{1,3}\.\d{1,3}\.\d{1,3}|localhost))" \
  "id:9005040,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'SSRF Attack: Internal IP address detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-ssrf',\
   tag:'paranoia-level/2',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}',\
   setvar:'tx.ssrf_score=+1'"

# Detect cloud metadata service access
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:169\.254\.169\.254|metadata\.google\.internal|169\.254\.170\.2)" \
  "id:9005041,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,\
   msg:'SSRF Attack: Cloud metadata service access attempt',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-ssrf',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}',\
   setvar:'tx.ssrf_score=+1'"

# ----------------------------------------
# HTTP Response Splitting Protection
# ----------------------------------------

# Detect CRLF injection attempts
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (?i:(%0d%0a|\\r\\n|\\u000d\\u000a))" \
  "id:9005050,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,\
   msg:'HTTP Response Splitting: CRLF injection detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-response-splitting',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# ----------------------------------------
# Session Fixation Protection
# ----------------------------------------

# Detect session ID manipulation
SecRule ARGS:PHPSESSID|ARGS:JSESSIONID|ARGS:ASP.NET_SessionId|REQUEST_COOKIES:PHPSESSID|REQUEST_COOKIES:JSESSIONID "@rx ^[a-zA-Z0-9]{20,}$" \
  "chain,\
   id:9005060,\
   phase:2,\
   pass,\
   t:none,\
   msg:'Session Fixation: Suspicious session ID pattern',\
   logdata:'Session ID: %{MATCHED_VAR}',\
   tag:'attack-session-fixation',\
   tag:'paranoia-level/3',\
   severity:'WARNING'"
SecRule MATCHED_VAR "@rx [^a-zA-Z0-9-]" \
  "t:none"

# ----------------------------------------
# HTTP Parameter Pollution (HPP) Protection
# ----------------------------------------

# Detect duplicate parameter names
SecRule &ARGS "@gt 20" \
  "id:9005070,\
   phase:2,\
   pass,\
   t:none,\
   msg:'HPP Attack: Excessive number of parameters',\
   logdata:'Parameter Count: %{ARGS}',\
   tag:'attack-hpp',\
   tag:'paranoia-level/2',\
   severity:'WARNING',\
   setvar:'tx.anomaly_score_pl2=+%{tx.warning_anomaly_score}'"

# ----------------------------------------
# Null Byte Injection Protection
# ----------------------------------------

# Detect null byte injection
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS \
  "@rx (%00|\\x00|\\0)" \
  "id:9005080,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,\
   msg:'Null Byte Injection: Null byte detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-null-byte',\
   tag:'paranoia-level/1',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# ----------------------------------------
# LDAP Injection Protection
# ----------------------------------------

# Detect LDAP injection attempts
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY \
  "@rx (?i:[\(\)&\|].*[\*\(\)&\|])" \
  "id:9005090,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,\
   msg:'LDAP Injection: LDAP filter metacharacters detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   tag:'attack-ldap',\
   tag:'paranoia-level/2',\
   severity:'CRITICAL',\
   setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}'"

# ----------------------------------------
# Attack Score Aggregation
# ----------------------------------------

# Aggregate attack scores
SecRule TX:LFI_SCORE "@gt 0" \
  "id:9005099,\
   phase:2,\
   pass,\
   msg:'Additional Attack Detected: LFI Score: %{TX.LFI_SCORE}',\
   tag:'attack-aggregate',\
   severity:'CRITICAL',\
   setvar:'tx.inbound_anomaly_score=+%{tx.lfi_score}'"

SecRule TX:RFI_SCORE "@gt 0" \
  "id:9005098,\
   phase:2,\
   pass,\
   msg:'Additional Attack Detected: RFI Score: %{TX.RFI_SCORE}',\
   tag:'attack-aggregate',\
   severity:'CRITICAL',\
   setvar:'tx.inbound_anomaly_score=+%{tx.rfi_score}'"

SecRule TX:RCE_SCORE "@gt 0" \
  "id:9005097,\
   phase:2,\
   pass,\
   msg:'Additional Attack Detected: RCE Score: %{TX.RCE_SCORE}',\
   tag:'attack-aggregate',\
   severity:'CRITICAL',\
   setvar:'tx.inbound_anomaly_score=+%{tx.rce_score}'"
